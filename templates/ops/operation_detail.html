{% extends "base.html" %}
{% load ops_extras %}
{% block title %}{{ op.title }} · C.K.F.R{% endblock %}
{% block body %}
{% ordered_users as assignable_users %}
<div class="max-w-5xl mx-auto p-4 sm:p-6 space-y-6">
  <div class="flex items-start justify-between gap-4">
    <div>
      <h1 class="text-2xl sm:text-3xl font-semibold">{{ op.title }}</h1>
      <p class="text-slate-300">{{ op.start|date:"d/m/Y H:i" }}</p>
    </div>
    <form method="post" action="{% url 'operation_add_ship' op.pk %}" class="flex gap-2 items-center">
      {% csrf_token %}
      {{ ship_form.ship }}
      <button class="rounded-lg bg-indigo-600 hover:bg-indigo-500 px-3 py-2">Ajouter un vaisseau</button>
    </form>
  </div>

  {% for os in ships %}
  <div class="rounded-xl border border-white/10 bg-white/5 p-4 space-y-4">
    <div class="font-medium">{{ os.ship.name }}</div>
    <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-3">
      {% for a in os.assignments.all %}
      <form method="post" action="{% url 'assignment_update' a.pk %}" class="rounded-lg bg-white/10 p-3 space-y-3">
        {% csrf_token %}
        <div class="text-sm text-slate-300">{{ a.role_name }}</div>
        <select name="user" class="w-full bg-white/5 border border-white/10 rounded px-2 py-1">
          <option value="">— libre —</option>
          {% for u in assignable_users %}
          <option value="{{ u.pk }}" {% if a.user_id == u.pk %}selected{% endif %}>{{ u.get_username }}</option>
          {% endfor %}
        </select>
        <select name="status" class="w-full bg-white/5 border border-white/10 rounded px-2 py-1">
          {% for key, label in a._meta.get_field('status').choices %}
          <option value="{{ key }}" {% if a.status == key %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        <button class="w-full rounded bg-indigo-600 hover:bg-indigo-500 px-3 py-1.5">Enregistrer</button>
      </form>
      {% empty %}
      <p class="text-sm text-slate-300">Aucune affectation.</p>
      {% endfor %}
    </div>
  </div>
  {% empty %}
  <p class="text-slate-300">Aucun vaisseau pour le moment.</p>
  {% endfor %}
</div>
{% endblock %}